# تغییرات تاریخچه تحلیل

## خلاصه تغییرات
تاریخچه معاملات با تاریخچه تحلیل جایگزین شد. این تغییر شامل موارد زیر است:

## 1. تغییرات در پایگاه داده (`src/database/repositories.py`)

### افزوده شد: `AnalysisHistoryRepository`
- `add_analysis()`: ذخیره تحلیل جدید
- `get_user_analyses()`: دریافت تاریخچه تحلیل‌های کاربر
- `get_analyses_by_symbol()`: دریافت تحلیل‌های یک ارز خاص
- `get_analysis_stats()`: دریافت آمار تحلیل‌ها (تعداد کل، سیگنال‌های خرید/فروش/نگهداری، میانگین اطمینان)

### ساختار داده تحلیل:
```python
{
    'user_id': int,
    'symbol': str,
    'signal_type': str,  # BUY, SELL, HOLD
    'confidence': float,
    'price': float,
    'rsi': float,
    'trend': str,
    'analysis_type': str,  # 'normal' or 'smart'
    'timestamp': datetime
}
```

## 2. تغییرات در هندلرها (`src/bot/handlers.py`)

### جایگزینی‌ها:
- ❌ `trade_history_repo` → ✅ `analysis_history_repo`
- ❌ `trades_command()` → ✅ `analyses_command()`
- ❌ `/trades` → ✅ `/analyses`

### دستورات به‌روزرسانی شده:
- `/analyses` - نمایش تاریخچه تحلیل‌ها
- `/performance` - نمایش آمار تحلیل‌ها به جای آمار معاملات

### ذخیره خودکار تحلیل:
- `perform_analysis()`: ذخیره تحلیل معمولی
- `smartanalyze_command()`: ذخیره تحلیل هوشمند

## 3. تغییرات در رابط کاربری

### متن‌های به‌روزرسانی شده:
- "تاریخچه معاملات" → "تاریخچه تحلیل‌ها"
- "📊 تاریخچه معاملات" → "📊 تاریخچه تحلیل"
- "آمار معاملات" → "آمار تحلیل‌ها"

### دکمه‌های کیبورد:
- "📊 تاریخچه معاملات" → "📊 تاریخچه تحلیل"

## 4. تغییرات در ثبت دستورات (`bot.py`)

```python
# قبل:
CommandHandler("trades", self.handlers.trades_command)

# بعد:
CommandHandler("analyses", self.handlers.analyses_command)
```

## 5. نمایش آمار جدید

### تاریخچه تحلیل (`/analyses`):
- نماد و نوع سیگنال (خرید/فروش/نگهداری)
- قیمت و درصد اطمینان
- زمان تحلیل
- آمار کلی: تعداد کل، سیگنال‌های خرید/فروش/نگهداری، میانگین اطمینان

### آمار عملکرد (`/performance`):
- کل تحلیل‌ها
- سیگنال خرید
- سیگنال فروش
- سیگنال نگهداری
- میانگین اطمینان

## نکات مهم

1. **مهاجرت داده‌ها**: داده‌های قدیمی معاملات همچنان در `trading_history` باقی می‌مانند ولی دیگر استفاده نمی‌شوند
2. **Collection جدید**: `analysis_history` در MongoDB ایجاد می‌شود
3. **ذخیره خودکار**: هر تحلیل (معمولی یا هوشمند) به صورت خودکار ذخیره می‌شود
4. **سازگاری**: کد قدیمی `TradingHistoryRepository` همچنان موجود است برای سازگاری با سایر بخش‌ها

## دستورات جدید

```bash
/analyses          # نمایش تاریخچه تحلیل‌ها
/performance       # نمایش آمار تحلیل‌ها
```

## تاریخ تغییرات
- 2025-01-27: جایگزینی کامل تاریخچه معاملات با تاریخچه تحلیل
